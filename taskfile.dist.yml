# https://taskfile.dev

version: "3"

vars:
  GREETING: Hello, World!

tasks:
  changelog:*:
    desc: |
      Create or append to CHANGELOG.md, need tag version.
      TAG -> Create a git tag, ex: v1.0.1.
      It will also update versioning file.
    vars:
      TAG: "{{index .MATCH 0}}"
      REPLACE_CMD: sed --in-place --regexp-extended
    cmds:
      - sed --in-place --regexp-extended 's/^version\s?=.*/version = "{{.TAG}}"/' {{.ROOT_DIR}}/pyproject.toml
      - cmd: >-
          sed --in-place --regexp-extended 's/version:.*/version: "{{.TAG}}"/' {{.ROOT_DIR}}/galaxy.yml
      - "git-cliff --prepend CHANGELOG.md --unreleased --tag {{.TAG}}"

  playbook:*:*:
    desc: |
      Run this plabyook:
      Param_1 -> Select only role with specific tag, you can view them from site.yml file.
      Param_2 -> inventory file content, default is localhost.
    vars:
      TAGS: '{{index .MATCH 0 | default "all"}}'
      INVENTORY: '{{.INVENTORY | default "127.0.0.1, --connection=local"}}'
    cmds:
      - cmd: >-
          ansible-playbook ansi_colle.linux.site --ask-become-pass
          --inventory {{.INVENTORY}} --tags {{.TAGS}}

  install:*:
    desc: |
      Install this collection and requirement.
      Param_1 -> Specify git branch or tag, default is main.
    vars:
      BRANCH: '{{index .MATCH 0 | default "main"}}'
      REPO_URL: git+https://github.com/ChunPanYung/ansi_colle-linux.git
    cmds:
      - ansible-galaxy collection install --upgrade --requirements-file {{.ROOT_DIR}}/requirements.yml
      - ansible-galaxy collection install --force {{.REPO_URL}},{{.BRANCH}}

  install:local:
    desc: Locally install current working directory.
    cmds:
      - ansible-galaxy collection install --upgrade --requirements-file {{.ROOT_DIR}}/requirements.yml
      - ansible-galaxy collection install --force {{.ROOT_DIR}}

  run:local:*:
    desc: Build and run working branch, then execute this branch with tags specified.
    vars:
      TAGS: '{{index .MATCH 0 | default "all"}}'
    cmds:
      - task: install:local
      - task: playbook:{{.TAGS}}

  build:docs:
    desc: Install current repo locally and create documentation using `antsibull-docs`.
    dir: "{{.ROOT_DIR}}"
    vars:
      DIST_DOCS: "{{.ROOT_DIR}}/dist/docs"
      COLLECTION_NAME: ansi_colle.linux
    cmds:
      - task: install:local
      - mkdir --parent {{.DIST_DOCS}}
      - antsibull-docs sphinx-init --use-current --squash-hierarchy --dest-dir {{.DIST_DOCS}} {{.COLLECTION_NAME}}
      - pip install --requirement {{.ROOT_DIR}}/dist/docs/requirements.txt
      - "{{.ROOT_DIR}}/dist/docs/build.sh"
      -  # Docs site should be located @ `build/html/index.html`

  watch:docs:
    desc: Watch changes on `argument_specs.yml` file and create docsite when changed.
    watch: true
    sources:
      - "**/argument_specs.yml"
    generates:
      - "{{.ROOT_DIR}}/dist/docs/build/html/index.html"
    cmds:
      - task: build:docs
