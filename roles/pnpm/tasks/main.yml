---
- name: Setup .npmrc on user directory
  community.general.ini_file:
    path: "{{ ansible_user_dir }}/.npmrc"
    option: prefix
    value: "{{ ansible_user_dir }}/.local"
    no_extra_spaces: true
    mode: '0600'
    backup: true

- name: Install pnpm for RedHat Based OS
  become: true
  when: ansible_os_family == 'RedHat'
  ansible.builtin.package:
    name: pnpm

- name: Install pnpm on Deiban
  when: ansible_os_family == 'Debian'
  block:
    - name: Install npm, dependencies for pnpm
      become: true
      ansible.builtin.apt:
        name: npm

    - name: Install pnpm via npm
      community.general.npm:
        name: pnpm
        global: true

- name: Setup pnpm global directory
  when: pnpm_run_setup
  ansible.builtin.command:
    cmd: pnpm setup
  register: pnpm_cmd
  changed_when: pnpm_cmd.stdout is search("Appended new lines")
  failed_when:
    - pnpm_cmd.rc != 0
    - pnpm_cmd.stdout is not search("already contains a pnpm section")

- name: Install Shell LSP via pnpm
  community.general.pnpm:
    name: bash-language-server
    global: true
