---
- name: Install pnpm for non Debian based OS
  become: true
  when: ansible_os_family != 'Debian'
  ansible.builtin.package:
    name: pnpm

- name: Install pnpm on Deiban
  when: ansible_os_family == 'Debian'
  block:
    - name: Install npm, dependencies for pnpm
      become: true
      ansible.builtin.apt:
        name: npm

    - name: Install pnpm via wget and configure bash
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          wget -qO- https://get.pnpm.io/install.sh |
          ENV="$HOME/.bashrc" SHELL="$(which bash)" bash -
      register: pnpm_shell
      changed_when: pnpm_shell.stdout is not search("*No changes to the environment*")

- name: Setup .npmrc on user directory
  community.general.ini_file:
    path: "{{ ansible_user_dir }}/.npmrc"
    option: prefix
    value: "{{ ansible_user_dir }}/.local"
    no_extra_spaces: true
    mode: '0600'
    backup: true

- name: Setup pnpm global directory
  ansible.builtin.command:
    cmd: pnpm setup
  register: pnpm_cmd
  changed_when: pnpm_cmd.stdout is search("Appended new lines")
  failed_when:
    - pnpm_cmd.rc != 0
    - pnpm_cmd.stdout is not search("already contains a pnpm section")

- name: Install Shell LSP via pnpm
  community.general.pnpm:
    name: bash-language-server
    global: true
